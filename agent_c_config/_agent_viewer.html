<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Configuration Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/yaml/yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/github.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --centric-blue: #2563eb;
            --centric-blue-dark: #1d4ed8;
            --centric-blue-light: #3b82f6;
            --centric-gray-50: #f8fafc;
            --centric-gray-100: #f1f5f9;
            --centric-gray-200: #e2e8f0;
            --centric-gray-300: #cbd5e1;
            --centric-gray-600: #475569;
            --centric-gray-700: #334155;
            --centric-gray-800: #1e293b;
            --centric-gray-900: #0f172a;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --error-red: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--centric-gray-50) 0%, var(--centric-gray-100) 100%);
            color: var(--centric-gray-800);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, var(--centric-blue) 0%, var(--centric-blue-dark) 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.15);
            flex-shrink: 0;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-primary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-success:disabled {
            background: var(--centric-gray-300);
            cursor: not-allowed;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: var(--centric-gray-50);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--centric-gray-200);
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: 600;
            color: var(--centric-gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--centric-gray-600);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--centric-gray-200);
            color: var(--centric-gray-800);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 1.5rem;
            flex: 1;
            min-height: 0;
        }

        .main-panel {
            display: flex;
            flex-direction: column;
            gap: 0;
            min-height: 0;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }

        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .main-panel > .panel {
            flex: 1;
            min-height: 0;
        }

        .panel-header {
            background: var(--centric-gray-50);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--centric-gray-200);
            font-weight: 600;
            color: var(--centric-gray-800);
            flex-shrink: 0;
        }

        .panel-content {
            padding: 1rem;
            flex: 1;
            overflow: hidden;
        }

        .upload-area {
            border: 2px dashed var(--centric-gray-200);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--centric-blue);
            background: var(--centric-gray-50);
        }

        .upload-area.dragover {
            border-color: var(--centric-blue);
            background: rgba(37, 99, 235, 0.05);
        }

        .file-input {
            display: none;
        }

        .editor-container {
            height: 100%;
            border: 1px solid var(--centric-gray-200);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .editor-tabs {
            display: flex;
            background: var(--centric-gray-100);
            border-bottom: 1px solid var(--centric-gray-200);
            flex-shrink: 0;
        }

        .editor-tab {
            padding: 0.75rem 1.5rem;
            background: var(--centric-gray-200);
            color: var(--centric-gray-600);
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s ease;
            border-right: 1px solid var(--centric-gray-300);
        }

        .editor-tab:first-child {
            border-top-left-radius: 8px;
        }

        .editor-tab.active {
            background: white;
            color: var(--centric-blue);
        }

        .editor-tab:hover:not(.active) {
            background: var(--centric-gray-100);
        }

        .tab-content {
            flex: 1;
            display: none;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .persona-preview {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
        }

        .persona-preview h1 {
            color: var(--centric-gray-800);
            border-bottom: 2px solid var(--centric-blue);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .persona-preview h2 {
            color: var(--centric-gray-700);
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .persona-preview h3 {
            color: var(--centric-gray-700);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .persona-preview code {
            background: var(--centric-gray-100);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
        }

        .persona-preview pre {
            background: var(--centric-gray-50);
            border-left: 4px solid var(--centric-blue);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            overflow-x: auto;
        }

        .persona-preview pre code {
            background: none;
            padding: 0;
        }

        .persona-preview blockquote {
            border-left: 4px solid var(--centric-gray-300);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--centric-gray-600);
            font-style: italic;
        }

        .persona-preview ul, .persona-preview ol {
            padding-left: 2rem;
            margin: 1rem 0;
        }

        .persona-preview li {
            margin: 0.5rem 0;
        }

        .persona-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--centric-gray-500);
            text-align: center;
        }

        .persona-empty i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .CodeMirror {
            height: 100%;
            font-size: 14px;
        }

        .validation-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .validation-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .validation-item.error {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--error-red);
        }

        .validation-item.warning {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning-orange);
        }

        .validation-item.success {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--success-green);
        }

        .validation-icon {
            margin-top: 2px;
        }

        .validation-message {
            flex: 1;
            font-size: 0.9rem;
        }

        .agent-info {
            display: grid;
            gap: 0.75rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: var(--centric-gray-50);
            border-radius: 6px;
        }

        .info-label {
            font-weight: 600;
            color: var(--centric-gray-700);
        }

        .info-value {
            color: var(--centric-gray-600);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
        }

        .tools-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .tool-tag {
            background: var(--centric-blue);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tool-tag.invalid {
            background: var(--error-red);
        }

        .categories-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .category-tag {
            background: var(--success-green);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .schema-info {
            font-size: 0.8rem;
            color: var(--centric-gray-600);
            padding: 0.75rem;
            background: var(--centric-gray-50);
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--centric-gray-500);
        }

        .empty-state i {
            font-size: 2rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-robot"></i>
                Agent Configuration Editor
            </div>
            <div class="header-actions">
                <button id="loadBtn" class="btn btn-primary">
                    <i class="fas fa-folder-open"></i>
                    Load Config
                </button>
                <button id="validateBtn" class="btn btn-primary">
                    <i class="fas fa-check-circle"></i>
                    Validate
                </button>
                <button id="saveBtn" class="btn btn-success" disabled>
                    <i class="fas fa-save"></i>
                    Save Config
                </button>
            </div>
        </div>
    </header>

    <!-- Load Configuration Modal -->
    <div id="loadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-upload"></i>
                    Load Configuration
                </div>
                <button class="modal-close" onclick="closeLoadModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--centric-blue); margin-bottom: 0.5rem;"></i>
                    <div><strong>Click to upload</strong> or drag and drop</div>
                    <div style="font-size: 0.9rem; color: var(--centric-gray-600); margin-top: 0.5rem;">
                        Agent configuration YAML files (.yaml, .yml)
                    </div>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".yaml,.yml">
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-panel">
            <div class="panel">
                <div class="panel-header">
                    <i class="fas fa-edit"></i>
                    Configuration Editor
                </div>
                <div class="panel-content" style="padding: 0; display: flex; flex-direction: column;">
                    <div class="editor-container">
                        <div class="editor-tabs">
                            <button class="editor-tab active" data-tab="yaml-editor">
                                <i class="fas fa-code"></i>
                                YAML Editor
                            </button>
                            <button class="editor-tab" data-tab="persona-preview">
                                <i class="fas fa-eye"></i>
                                Persona Preview
                            </button>
                        </div>

                        <div id="yaml-editor-tab" class="tab-content active">
                            <textarea id="yamlEditor" placeholder="Load a configuration file to start editing..."></textarea>
                        </div>

                        <div id="persona-preview-tab" class="tab-content">
                            <div class="persona-preview" id="personaPreview">
                                <div class="persona-empty">
                                    <i class="fas fa-user-tie"></i>
                                    <h3>No Persona Available</h3>
                                    <p>Load a configuration file to see the persona preview</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="panel">
                <div class="panel-header">
                    <i class="fas fa-info-circle"></i>
                    Agent Information
                </div>
                <div class="panel-content">
                    <div id="agentInfo" class="agent-info">
                        <div class="empty-state">
                            <i class="fas fa-robot"></i>
                            <p>Load a configuration to see agent details</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    Validation Results
                </div>
                <div class="panel-content">
                    <div id="validationResults" class="validation-results">
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <p>Click validate to check configuration</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <i class="fas fa-book"></i>
                    Schema Reference
                </div>
                <div class="panel-content">
                    <div class="schema-info">
                        <strong>Required Fields:</strong><br>
                        • version (number)<br>
                        • name (string)<br>
                        • key (snake_case string)<br>
                        • agent_description (string)<br>
                        • model_id (string)<br>
                        • tools (array of class names)<br>
                        • agent_params (object)<br>
                        • category (array)<br>
                        • persona (string)<br><br>

                        <strong>Valid Tools:</strong><br>
                        <div style="max-height: 150px; overflow-y: auto; margin-top: 0.5rem; font-size: 0.75rem; line-height: 1.4;">
                        Essential: MemoryTools, ThinkTools, MarkdownToHtmlReportTools<br>
                        Code: CssExplorerTools, XmlExplorerTools<br>
                        Workspace: WorkspaceTools, LocalStorageWorkspace, WorkspaceSection, WorkspacePlanningTools, WorkspaceKnowledgeTools, WorkspaceSequentialThinkingTools<br>
                        Web: WebSearchTools, WikipediaTools, HackerNewsTools, SeekingAlphaTools, TavilyResearchTools, GoogleSerpTools, GoogleTrendsTools, NewsApiTools, WebTools, GmailSearch, GmailMessage, LinkedInTools<br>
                        YouTube: YoutubeTranscriptTools, YoutubeCommentsTools, YoutubeSearchViaApiTools, YoutubeSearchViaWebTools<br>
                        CRM: DynamicsTools, SalesforceTools<br>
                        Other: RssTools, MermaidChartTools, DallETools, UserBioTools, Weather, RandomNumberTools, MathTools, BrowserPlaywrightTools, CodeInterpreterTools, DataVisualizationTools, DatabaseQueryTools, MariadbTools, DataframeTools<br>
                        Health: FDANDCTools, ClinicalTrialsTools, PubMedTools<br>
                        Demo: SarsTools, InsuranceDemoTools<br>
                        Dynamic: DynamicCommandTools<br>
                        Legacy: AgentAssistTools, AgentCloneTools, AgentTeamTools
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize CodeMirror editor
        const editor = CodeMirror.fromTextArea(document.getElementById('yamlEditor'), {
            mode: 'yaml',
            theme: 'github',
            lineNumbers: true,
            lineWrapping: true,
            indentUnit: 2,
            tabSize: 2,
            indentWithTabs: false,
            autoCloseBrackets: true,
            matchBrackets: true
        });

        let currentConfig = null;
        let currentFileName = null;

        // Valid tools list (comprehensive)
        const validTools = [
            // Essential Tools for good agents
            'MemoryTools',
            'ThinkTools',
            'MarkdownToHtmlReportTools',

            // Code Exploring Tools
            'CssExplorerTools',
            'XmlExplorerTools',

            // Workspace tools
            'WorkspaceTools',
            'LocalStorageWorkspace',
            'WorkspaceSection',

            // Planning and Knowledge Tools
            'WorkspacePlanningTools',
            'WorkspaceKnowledgeTools',
            'WorkspaceSequentialThinkingTools',

            // Web tools
            'WebSearchTools',
            'WikipediaTools',
            'HackerNewsTools',
            'SeekingAlphaTools',
            'TavilyResearchTools',
            'GoogleSerpTools',
            'GoogleTrendsTools',
            'NewsApiTools',
            'WebTools',
            'GmailSearch',
            'GmailMessage',
            'LinkedInTools',

            // YouTube Tools
            'YoutubeTranscriptTools',
            'YoutubeCommentsTools',
            'YoutubeSearchViaApiTools',
            'YoutubeSearchViaWebTools',

            // CRM Tools
            'DynamicsTools',
            'SalesforceTools',

            // User preference tools
            'UserPreference',
            'AddressMeAsPreference',
            'AssistantPersonalityPreference',
            'UserPreferencesTools',

            // Other tools
            'RssTools',
            'MermaidChartTools',
            'DallETools',
            'UserBioTools',
            'Weather',
            'RandomNumberTools',
            'MathTools',
            'BrowserPlaywrightTools',
            'CodeInterpreterTools',

            // Data tools
            'DataVisualizationTools',
            'DatabaseQueryTools',
            'MariadbTools',
            'DataframeTools',

            // Health Information tools
            'FDANDCTools',
            'ClinicalTrialsTools',
            'PubMedTools',

            // Client Demo Only
            'SarsTools',
            'InsuranceDemoTools',

            // Whitelisted Dynamic Command Toolset
            'DynamicCommandTools',
            
            // Legacy/compatibility
            'AgentAssistTools',
            'AgentCloneTools',
            'AgentTeamTools'
        ];

        // Valid model IDs
        const validModels = [
            'claude-sonnet-4-20250514',
            'claude-opus-4',
            'claude-haiku-4'
        ];

        // Schema definition for agent configuration
        const agentSchema = {
            required: ['version', 'name', 'key', 'agent_description', 'model_id', 'tools', 'agent_params', 'category', 'persona'],
            properties: {
                version: { type: 'number', values: [2] },
                name: { type: 'string' },
                key: { type: 'string', pattern: /^[a-z][a-z0-9_]*$/ },
                agent_description: { type: 'string' },
                model_id: { type: 'string', enum: validModels },
                tools: { type: 'array', items: { type: 'string', enum: validTools } },
                agent_params: {
                    type: 'object',
                    required: ['budget_tokens', 'max_tokens'],
                    properties: {
                        budget_tokens: { type: 'number' },
                        max_tokens: { type: 'number' }
                    }
                },
                category: { type: 'array', items: { type: 'string' } },
                persona: { type: 'string' },
                prompt_metadata: { type: 'object', optional: true }
            }
        };

        // Modal functions
        function openLoadModal() {
            document.getElementById('loadModal').classList.add('active');
        }

        function closeLoadModal() {
            document.getElementById('loadModal').classList.remove('active');
        }

        // Close modal on outside click
        document.getElementById('loadModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeLoadModal();
            }
        });

        // Event listeners
        document.getElementById('loadBtn').addEventListener('click', openLoadModal);
        document.getElementById('fileInput').addEventListener('change', handleFileLoad);
        document.getElementById('validateBtn').addEventListener('click', validateConfig);
        document.getElementById('saveBtn').addEventListener('click', saveConfig);

        // Tab switching
        document.querySelectorAll('.editor-tab').forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.dataset.tab));
        });

        // Drag and drop functionality
        const uploadArea = document.querySelector('.upload-area');
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleFileDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);

        // Auto-validate on editor changes
        editor.on('change', debounce(() => {
            validateConfig();
            updatePersonaPreview();
        }, 1000));

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                loadFile(files[0]);
                closeLoadModal();
            }
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (file) {
                loadFile(file);
                closeLoadModal();
            }
        }

        function loadFile(file) {
            currentFileName = file.name;
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const yamlContent = e.target.result;
                    editor.setValue(yamlContent);

                    // Parse and validate immediately
                    currentConfig = jsyaml.load(yamlContent);
                    updateAgentInfo(currentConfig);
                    updatePersonaPreview();
                    validateConfig();

                } catch (error) {
                    showValidationError('Failed to load file: ' + error.message);
                }
            };

            reader.readAsText(file);
        }

        function validateConfig() {
            try {
                // Parse YAML
                const yamlContent = editor.getValue();
                if (!yamlContent.trim()) {
                    showEmptyValidation();
                    return;
                }

                currentConfig = jsyaml.load(yamlContent);
                const validationResults = [];

                // Check for required fields
                agentSchema.required.forEach(field => {
                    if (!(field in currentConfig)) {
                        validationResults.push({
                            type: 'error',
                            message: `Missing required field: '${field}'`
                        });
                    }
                });

                // Check for extra fields
                Object.keys(currentConfig).forEach(field => {
                    if (!(field in agentSchema.properties)) {
                        validationResults.push({
                            type: 'warning',
                            message: `Unknown field: '${field}' (not in schema)`
                        });
                    }
                });

                // Validate field types and values
                Object.entries(agentSchema.properties).forEach(([field, schema]) => {
                    if (field in currentConfig) {
                        const value = currentConfig[field];
                        const fieldResults = validateField(field, value, schema);
                        validationResults.push(...fieldResults);
                    }
                });

                // Special validations
                validateTools(currentConfig, validationResults);
                validateAgentParams(currentConfig, validationResults);
                validateKey(currentConfig, validationResults);

                displayValidationResults(validationResults);
                updateAgentInfo(currentConfig);

                // Enable save button if no errors
                const hasErrors = validationResults.some(r => r.type === 'error');
                document.getElementById('saveBtn').disabled = hasErrors || !yamlContent.trim();

            } catch (error) {
                showValidationError('YAML parsing error: ' + error.message);
                document.getElementById('saveBtn').disabled = true;
            }
        }

        function validateField(fieldName, value, schema) {
            const results = [];
            const actualType = Array.isArray(value) ? 'array' : typeof value;

            // Type validation
            if (schema.type && actualType !== schema.type) {
                results.push({
                    type: 'error',
                    message: `Field '${fieldName}' should be ${schema.type}, got ${actualType}`
                });
                return results;
            }

            // Enum validation
            if (schema.enum && !schema.enum.includes(value)) {
                results.push({
                    type: 'error',
                    message: `Field '${fieldName}' has invalid value '${value}'. Valid values: ${schema.enum.join(', ')}`
                });
            }

            // Pattern validation
            if (schema.pattern && typeof value === 'string' && !schema.pattern.test(value)) {
                results.push({
                    type: 'error',
                    message: `Field '${fieldName}' doesn't match required pattern (should be snake_case)`
                });
            }

            // Array validation
            if (schema.type === 'array' && schema.items) {
                value.forEach((item, index) => {
                    if (schema.items.enum && !schema.items.enum.includes(item)) {
                        results.push({
                            type: 'error',
                            message: `Invalid array item in '${fieldName}[${index}]': '${item}'`
                        });
                    }
                });
            }

            return results;
        }

        function validateTools(config, results) {
            if (config.tools) {
                // Check for quoted tools (common mistake)
                config.tools.forEach((tool, index) => {
                    if (tool.includes('"') || tool.includes("'")) {
                        results.push({
                            type: 'error',
                            message: `Tool '${tool}' appears to be quoted - should be class name without quotes`
                        });
                    }
                });

                // Check for common typos or invalid tools
                const invalidTools = config.tools.filter(tool => !validTools.includes(tool));
                if (invalidTools.length > 0) {
                    invalidTools.forEach(tool => {
                        results.push({
                            type: 'error',
                            message: `Invalid tool: '${tool}'. Check schema reference for valid tools.`
                        });
                    });
                }
            }
        }

        function validateAgentParams(config, results) {
            if (config.agent_params) {
                const required = ['budget_tokens', 'max_tokens'];
                required.forEach(param => {
                    if (!(param in config.agent_params)) {
                        results.push({
                            type: 'error',
                            message: `Missing required agent_params field: '${param}'`
                        });
                    } else if (typeof config.agent_params[param] !== 'number') {
                        results.push({
                            type: 'error',
                            message: `agent_params.${param} should be a number`
                        });
                    }
                });
            }
        }

        function validateKey(config, results) {
            if (config.key) {
                // Check for spaces or invalid characters
                if (config.key.includes(' ')) {
                    results.push({
                        type: 'error',
                        message: `Key '${config.key}' contains spaces - should be snake_case`
                    });
                }

                if (!/^[a-z][a-z0-9_]*$/.test(config.key)) {
                    results.push({
                        type: 'error',
                        message: `Key '${config.key}' should be snake_case (lowercase, underscores only)`
                    });
                }
            }
        }

        function displayValidationResults(results) {
            const container = document.getElementById('validationResults');

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="validation-item success">
                        <i class="fas fa-check-circle validation-icon" style="color: var(--success-green);"></i>
                        <div class="validation-message">Configuration is valid! No issues found.</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = results.map(result => `
                <div class="validation-item ${result.type}">
                    <i class="fas ${getValidationIcon(result.type)} validation-icon" style="color: var(--${getValidationColor(result.type)});"></i>
                    <div class="validation-message">${result.message}</div>
                </div>
            `).join('');
        }

        function getValidationIcon(type) {
            switch (type) {
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'success': return 'fa-check-circle';
                default: return 'fa-info-circle';
            }
        }

        function getValidationColor(type) {
            switch (type) {
                case 'error': return 'error-red';
                case 'warning': return 'warning-orange';
                case 'success': return 'success-green';
                default: return 'centric-blue';
            }
        }

        function updateAgentInfo(config) {
            const container = document.getElementById('agentInfo');

            if (!config) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-robot"></i>
                        <p>Load a configuration to see agent details</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="info-item">
                    <span class="info-label">Name:</span>
                    <span class="info-value">${config.name || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Key:</span>
                    <span class="info-value">${config.key || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Version:</span>
                    <span class="info-value">${config.version || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Model:</span>
                    <span class="info-value">${config.model_id || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Tools:</span>
                    <div class="tools-list">
                        ${config.tools ? config.tools.map(tool =>
                            `<span class="tool-tag ${validTools.includes(tool) ? '' : 'invalid'}">${tool}</span>`
                        ).join('') : 'N/A'}
                    </div>
                </div>
                <div class="info-item">
                    <span class="info-label">Categories:</span>
                    <div class="categories-list">
                        ${config.category ? config.category.map(cat =>
                            `<span class="category-tag">${cat}</span>`
                        ).join('') : 'N/A'}
                    </div>
                </div>
                ${config.agent_params ? `
                <div class="info-item">
                    <span class="info-label">Budget:</span>
                    <span class="info-value">${config.agent_params.budget_tokens || 'N/A'} tokens</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Max Tokens:</span>
                    <span class="info-value">${config.agent_params.max_tokens || 'N/A'} tokens</span>
                </div>
                ` : ''}
            `;
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.editor-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            if (tabName === 'yaml-editor') {
                document.getElementById('yaml-editor-tab').classList.add('active');
                // Refresh editor to ensure proper display
                setTimeout(() => editor.refresh(), 0);
            } else if (tabName === 'persona-preview') {
                document.getElementById('persona-preview-tab').classList.add('active');
                updatePersonaPreview();
            }
        }

        function updatePersonaPreview() {
            const previewContainer = document.getElementById('personaPreview');

            try {
                const yamlContent = editor.getValue();
                if (!yamlContent.trim()) {
                    showEmptyPersona();
                    return;
                }

                const config = jsyaml.load(yamlContent);

                if (!config || !config.persona) {
                    showEmptyPersona();
                    return;
                }

                // Configure marked with options
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    headerIds: false,
                    mangle: false
                });

                // Render markdown to HTML
                const personaHtml = marked.parse(config.persona);
                previewContainer.innerHTML = personaHtml;

            } catch (error) {
                previewContainer.innerHTML = `
                    <div class="persona-empty">
                        <i class="fas fa-exclamation-circle" style="color: var(--error-red);"></i>
                        <h3>Error Parsing Configuration</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function showEmptyPersona() {
            const previewContainer = document.getElementById('personaPreview');
            previewContainer.innerHTML = `
                <div class="persona-empty">
                    <i class="fas fa-user-tie"></i>
                    <h3>No Persona Available</h3>
                    <p>Load a configuration file with a persona section to see the preview</p>
                </div>
            `;
        }

        function showValidationError(message) {
            const container = document.getElementById('validationResults');
            container.innerHTML = `
                <div class="validation-item error">
                    <i class="fas fa-exclamation-circle validation-icon" style="color: var(--error-red);"></i>
                    <div class="validation-message">${message}</div>
                </div>
            `;
        }

        function showEmptyValidation() {
            document.getElementById('validationResults').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <p>Click validate to check configuration</p>
                </div>
            `;
        }

        function saveConfig() {
            if (!currentConfig) return;

            try {
                const yamlContent = editor.getValue();
                const blob = new Blob([yamlContent], { type: 'text/yaml' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = currentFileName || `${currentConfig.key || 'agent_config'}.yaml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                alert('Error saving file: ' + error.message);
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize editor with placeholder
        editor.setValue(`# Load a configuration file to start editing
# Click the "Load Config" button in the header
# or create a new one using this template:

version: 2
name: "My New Agent"
key: "my_new_agent"
agent_description: |
  Description of what this agent does
model_id: "claude-sonnet-4-20250514"
tools:
  - ThinkTools
  - WorkspaceTools
  - MemoryTools
agent_params:
  budget_tokens: 20000
  max_tokens: 64000
category:
  - "domo"
  - "agent_assist"
persona: |
  You are a helpful assistant...
`);
    </script>
</body>
</html>
